<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consultorio Académico Virtual Empresarial Uniminuto - Ejecución del Servicio</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="wrapper">
    <header>
      <h1>Consultorio Académico Virtual Empresarial Uniminuto</h1>
      <nav>
        <ul>
          <li><a href="../index.html">Inicio</a></li>
          <li><a href="catalogo.html">Catálogo</a></li>
          <li><a href="registro.html">Registro</a></li>
          <li><a href="perfil.html">Perfil</a></li>
          <li><a href="gestion.html">Gestión</a></li>
          <li><a href="ejecucion.html" class="active">Ejecución</a></li>
          <li><a href="solicitudes.html">Solicitudes</a></li>
          <li><a href="notificaciones.html">Notificaciones</a></li>
          <li><a href="ayuda.html">Ayuda</a></li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <main>
        <!-- Sección nueva para Solicitudes -->
        <div class="section">
          <h2>Solicitudes en Curso</h2>
          <table id="solicitudes">
            <thead>
              <tr>
                <th>ID Solicitud</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Estado</th>
                <th>Fecha Creación</th>
                <th>Fecha Respuesta</th>
                <th>Asesor</th>
                <th>Asignar a</th>
              </tr>
            </thead>
            <tbody>
              <!-- Aquí se cargarán dinámicamente las solicitudes -->
            </tbody>
          </table>
        </div>

        <!-- Mover aquí el botón "Volver al inicio" -->
        <a href="../index.html" class="volver">← Volver al inicio</a>
      </main>      
    </div>
  </div>

  <footer>
    <p>&copy; 2025 CAVE-U</p>
  </footer>

  <script>
    // No necesitamos una lista predefinida de asesores
    // ya que usaremos un campo de texto libre

    // Cargar datos guardados al iniciar la página
    document.addEventListener('DOMContentLoaded', function() {
      cargarTablasGuardadas();
      cargarSolicitudesGuardadas();
    });
    
    function cargarTablasGuardadas() {
      // Intentar cargar tareas guardadas
      const tareasGuardadas = JSON.parse(localStorage.getItem('tareas')) || [];
      
      // Comprobar si el elemento existe antes de intentar usarlo
      const elementoTareas = document.getElementById('tareas');
      if (elementoTareas) {
        const tablasTareas = elementoTareas.getElementsByTagName('tbody')[0];
        tablasTareas.innerHTML = '';
        
        tareasGuardadas.forEach(tarea => {
          const fila = tablasTareas.insertRow();
          
          // Añadir celdas con los datos
          const celdaDesc = fila.insertCell();
          celdaDesc.textContent = tarea.descripcion;
          
          const celdaEstado = fila.insertCell();
          celdaEstado.textContent = tarea.estado;
          
          const celdaResp = fila.insertCell();
          celdaResp.textContent = tarea.responsable;
          
          const celdaFecha = fila.insertCell();
          celdaFecha.textContent = tarea.fecha;
          
          // Añadir botones de acción
          const celdaAcciones = fila.insertCell();
          celdaAcciones.innerHTML = `
            <button onclick="editarFila(this, 'tareas')">Editar</button>
            <button onclick="eliminarFila(this, 'tareas', ${tarea.id})">Eliminar</button>
          `;
        });
      }
      
      // Intentar cargar informes guardados
      const informesGuardados = JSON.parse(localStorage.getItem('informes')) || [];
      
      // Comprobar si el elemento existe antes de intentar usarlo
      const elementoInformes = document.getElementById('informes');
      if (elementoInformes) {
        const tablasInformes = elementoInformes.getElementsByTagName('tbody')[0];
        tablasInformes.innerHTML = '';
        
        informesGuardados.forEach(informe => {
          const fila = tablasInformes.insertRow();
          
          // Añadir celdas con los datos
          const celdaTitulo = fila.insertCell();
          celdaTitulo.textContent = informe.titulo;
          
          const celdaDesc = fila.insertCell();
          celdaDesc.textContent = informe.descripcion;
          
          const celdaArchivo = fila.insertCell();
          celdaArchivo.textContent = informe.archivo;
          
          const celdaFecha = fila.insertCell();
          celdaFecha.textContent = informe.fecha;
          
          // Añadir botones de acción
          const celdaAcciones = fila.insertCell();
          celdaAcciones.innerHTML = `
            <button onclick="editarFila(this, 'informes')">Editar</button>
            <button onclick="eliminarFila(this, 'informes', ${informe.id})">Eliminar</button>
          `;
        });
      }
    }

    // Función modificada para cargar solicitudes
    function cargarSolicitudesGuardadas() {
      const solicitudesGuardadas = JSON.parse(localStorage.getItem('solicitudesDetalle')) || [];
      const tablaSolicitudes = document.getElementById('solicitudes').getElementsByTagName('tbody')[0];
      tablaSolicitudes.innerHTML = '';
      
      solicitudesGuardadas.forEach(solicitud => {
        const fila = tablaSolicitudes.insertRow();
        
        // Añadir celdas con los datos
        const celdaId = fila.insertCell();
        celdaId.textContent = solicitud.idSolicitud;
        
        const celdaTipo = fila.insertCell();
        celdaTipo.textContent = solicitud.tipoSolicitud;
        
        const celdaDesc = fila.insertCell();
        celdaDesc.textContent = solicitud.descripcion;
        
        const celdaEstado = fila.insertCell();
        celdaEstado.textContent = solicitud.estado;
        
        const celdaFechaCreacion = fila.insertCell();
        celdaFechaCreacion.textContent = solicitud.fechaCreacion;
        
        const celdaFechaRespuesta = fila.insertCell();
        celdaFechaRespuesta.textContent = solicitud.fechaRespuesta || '-';
        
        // Celda para el asesor asignado
        const celdaAsesor = fila.insertCell();
        celdaAsesor.textContent = solicitud.asesor || 'Sin asignar';
        celdaAsesor.id = `asesor-${solicitud.idSolicitud}`;
        
        // Celda para selector de asesores
        const celdaAsignar = fila.insertCell();
        celdaAsignar.innerHTML = generarSelectorAsesores(solicitud.idSolicitud);
      });
    }

    // Función para generar el campo de texto para el asesor
    function generarSelectorAsesores(idSolicitud) {
      let inputHTML = `
        <input type="text" id="selector-${idSolicitud}" placeholder="Nombre del asesor">
        <button onclick="asignarAsesor('${idSolicitud}')">Asignar</button>`;
      
      return inputHTML;
    }

    // Función para asignar un asesor a una solicitud
    function asignarAsesor(idSolicitud) {
      const campoTexto = document.getElementById(`selector-${idSolicitud}`);
      const asesorSeleccionado = campoTexto.value.trim();
      
      if (!asesorSeleccionado) {
        alert('Por favor, ingrese el nombre del asesor.');
        return;
      }
      
      // Actualizar la celda de visualización
      const celdaAsesor = document.getElementById(`asesor-${idSolicitud}`);
      celdaAsesor.textContent = asesorSeleccionado;
      
      // Actualizar en localStorage
      const solicitudesGuardadas = JSON.parse(localStorage.getItem('solicitudesDetalle')) || [];
      const solicitudIndex = solicitudesGuardadas.findIndex(sol => sol.idSolicitud === idSolicitud);
      
      if (solicitudIndex !== -1) {
        solicitudesGuardadas[solicitudIndex].asesor = asesorSeleccionado;
        localStorage.setItem('solicitudesDetalle', JSON.stringify(solicitudesGuardadas));
        
        // Mostrar mensaje de confirmación
        alert(`Solicitud #${idSolicitud} asignada a ${asesorSeleccionado}`);
      }
    }

    function agregarFila(tablaId) {
      const tabla = document.getElementById(tablaId).getElementsByTagName('tbody')[0];
      const fila = tabla.insertRow();
      const columnas = 4;

      for (let i = 0; i < columnas; i++) {
        const celda = fila.insertCell();
        celda.innerHTML = `<input type="text">`;
      }

      const celdaAcciones = fila.insertCell();
      celdaAcciones.innerHTML = `
        <button onclick="guardarFila(this, '${tablaId}')">Guardar</button>
        <button onclick="eliminarFila(this)">Eliminar</button>
      `;
    }

    function guardarFila(boton, tablaId) {
      const fila = boton.closest('tr');
      const celdas = fila.querySelectorAll('td');
      let datos = [];

      for (let i = 0; i < celdas.length - 1; i++) {
        const input = celdas[i].querySelector('input');
        const valor = input ? input.value.trim() : '';
        datos.push(valor);
        celdas[i].textContent = valor;
      }

      // Crear objeto para guardar según el tipo de tabla
      const id = Date.now();
      let itemGuardar;
      
      if (tablaId === "tareas") {
        itemGuardar = {
          id: id,
          descripcion: datos[0] || "Sin descripción",
          estado: datos[1] || "Pendiente",
          responsable: datos[2] || "",
          fecha: datos[3] || new Date().toLocaleDateString()
        };
        
        // Guardar en localStorage
        const tareasGuardadas = JSON.parse(localStorage.getItem('tareas')) || [];
        tareasGuardadas.push(itemGuardar);
        localStorage.setItem('tareas', JSON.stringify(tareasGuardadas));
        
        // También guardar como solicitud
        guardarEnLocalStorage({
          id: id,
          tipo: "Tarea",
          estado: itemGuardar.estado,
          responsable: itemGuardar.responsable,
          fecha: itemGuardar.fecha
        });
      } else if (tablaId === "informes") {
        itemGuardar = {
          id: id,
          titulo: datos[0] || "Sin título",
          descripcion: datos[1] || "",
          archivo: datos[2] || "",
          fecha: datos[3] || new Date().toLocaleDateString()
        };
        
        // Guardar en localStorage
        const informesGuardados = JSON.parse(localStorage.getItem('informes')) || [];
        informesGuardados.push(itemGuardar);
        localStorage.setItem('informes', JSON.stringify(informesGuardados));
      }

      celdas[celdas.length - 1].innerHTML = `
        <button onclick="editarFila(this, '${tablaId}')">Editar</button>
        <button onclick="eliminarFila(this, '${tablaId}', ${id})">Eliminar</button>
      `;
    }

    function editarFila(boton, tablaId) {
      const fila = boton.closest('tr');
      const celdas = fila.querySelectorAll('td');

      for (let i = 0; i < celdas.length - 1; i++) {
        const texto = celdas[i].textContent;
        celdas[i].innerHTML = `<input type="text" value="${texto}">`;
      }

      celdas[celdas.length - 1].innerHTML = `
        <button onclick="guardarEdicion(this, '${tablaId}')">Guardar</button>
        <button onclick="eliminarFila(this)">Eliminar</button>
      `;
    }
    
    function guardarEdicion(boton, tablaId) {
      const fila = boton.closest('tr');
      const celdas = fila.querySelectorAll('td');
      let datos = [];
      
      // ID original para identificar el elemento a actualizar
      const filaIndex = fila.rowIndex - 1; // Restar 1 por el encabezado
      
      for (let i = 0; i < celdas.length - 1; i++) {
        const input = celdas[i].querySelector('input');
        const valor = input ? input.value.trim() : '';
        datos.push(valor);
        celdas[i].textContent = valor;
      }
      
      if (tablaId === "tareas") {
        // Actualizar tarea en localStorage
        const tareasGuardadas = JSON.parse(localStorage.getItem('tareas')) || [];
        if (filaIndex >= 0 && filaIndex < tareasGuardadas.length) {
          const id = tareasGuardadas[filaIndex].id;
          tareasGuardadas[filaIndex] = {
            id: id,
            descripcion: datos[0],
            estado: datos[1],
            responsable: datos[2],
            fecha: datos[3]
          };
          localStorage.setItem('tareas', JSON.stringify(tareasGuardadas));
          
          celdas[celdas.length - 1].innerHTML = `
            <button onclick="editarFila(this, '${tablaId}')">Editar</button>
            <button onclick="eliminarFila(this, '${tablaId}', ${id})">Eliminar</button>
          `;
        }
      } else if (tablaId === "informes") {
        // Actualizar informe en localStorage
        const informesGuardados = JSON.parse(localStorage.getItem('informes')) || [];
        if (filaIndex >= 0 && filaIndex < informesGuardados.length) {
          const id = informesGuardados[filaIndex].id;
          informesGuardados[filaIndex] = {
            id: id,
            titulo: datos[0],
            descripcion: datos[1],
            archivo: datos[2],
            fecha: datos[3]
          };
          localStorage.setItem('informes', JSON.stringify(informesGuardados));
          
          celdas[celdas.length - 1].innerHTML = `
            <button onclick="editarFila(this, '${tablaId}')">Editar</button>
            <button onclick="eliminarFila(this, '${tablaId}', ${id})">Eliminar</button>
          `;
        }
      }
    }

    function eliminarFila(boton, tablaId, id) {
      const fila = boton.closest('tr');
      const filaIndex = fila.rowIndex - 1; // Restar 1 por el encabezado
      
      if (tablaId === "tareas") {
        // Eliminar de localStorage
        const tareasGuardadas = JSON.parse(localStorage.getItem('tareas')) || [];
        if (id && tareasGuardadas.length > 0) {
          const nuevasTareas = tareasGuardadas.filter(tarea => tarea.id !== id);
          localStorage.setItem('tareas', JSON.stringify(nuevasTareas));
        }
      } else if (tablaId === "informes") {
        // Eliminar de localStorage
        const informesGuardados = JSON.parse(localStorage.getItem('informes')) || [];
        if (id && informesGuardados.length > 0) {
          const nuevosInformes = informesGuardados.filter(informe => informe.id !== id);
          localStorage.setItem('informes', JSON.stringify(nuevosInformes));
        }
      }
      
      // Eliminar fila de la tabla
      fila.remove();
    }

    function guardarEnLocalStorage(solicitud) {
      const solicitudes = JSON.parse(localStorage.getItem("solicitudes")) || [];
      solicitudes.push(solicitud);
      localStorage.setItem("solicitudes", JSON.stringify(solicitudes));
    }
  </script>
</body>
</html>